require './FlightGoogle'
require 'date'
require 'mongo'
include Mongo

# initialize database
client = MongoClient.new
db = client.db('Flightdb')

# para settings
dtReserve = Date.today
ibcity = 'ORY,CDG'
obcity = 'PEK'

maxObdate = 360
minObdate = 7
maxIbdate = 90
minIbdate = 14

#obDate = '2014-04-01'
#ibDate = '2014-04-08'


# set collection
coll = db['PARPEK']

beginning = Time.now

# launch search engine
for i in 22..maxObdate do
  obDate = (dtReserve+i)
  ibDate = (obDate + minIbdate)
  puts "searching starts with #{obDate}~#{ibDate}"

  my_flight = FlightGoogle.new(ibcity,obcity,obDate,ibDate)
  puts my_flight.getURL
  my_flight.gotob

  puts "getting report........."
  my_flight_report = my_flight.getReport
  nbRow = my_flight_report['dtPrice'].collect.size

# rewrite the matrix
  for i in 1..nbRow do
    new_flight_report = Hash.new
    new_flight_report["flights"]=Hash.new
    new_flight_report['dtReserve'] = dtReserve.to_s
    new_flight_report['obDate'] = obDate.to_s
    new_flight_report['ibDate'] = ibDate.to_s
    new_flight_report["flights"] = {
        :dtComp=>my_flight_report['dtComp'][i],
        :dtPrice=>my_flight_report['dtPrice'][i],
        :dtHours=>my_flight_report['dtHours'][i],
        :dtTrans=>my_flight_report['dtTrans'][i],
    }
    coll.insert(new_flight_report)
  end

  my_flight.closeb
  puts "Time elapsed #{Time.now - beginning} seconds"
end

puts "Routine terminated and time elapsed #{Time.now - beginning} seconds"
